<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-155986583-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-155986583-1');
    </script>



    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

    <link rel="stylesheet" href="/media/css/all.css">
    <link rel="stylesheet" href="/media/css/profile.css">
    <link rel="stylesheet" href="/media/css/timetable.min.css">
    <link rel="stylesheet" href="/media/tipuesearch/tipuesearch.css">
    <link rel="stylesheet" href="/media/fonts/nebula/Nebula/font.css">

    <title>M5MAT</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.js" integrity="sha256-H9jAz//QLkDOy/nzE9G4aYijQtkLt9FvGmdUTwBk6gs=" crossorigin="anonymous"></script>


      <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>


    <style>

    @font-face {
      font-family: 'Turtles';
      src: url('/media/fonts/turtles/Turtles.ttf')  format('truetype'); /* Safari, Android, iOS */
    }

    @font-face {
      font-family: 'Betty Noir';
      src: url('/media/fonts/bettynoir/bettynoir.ttf')  format('truetype'); /* Safari, Android, iOS */
    }

    @font-face {
      font-family: 'Paris';
      src: url('/media/fonts/paris/paris.ttf')  format('truetype'); /* Safari, Android, iOS */
    }

    .navbar-brand, .header-text {
      font-family: 'Nebula', Roboto, Calibri, Arial;
    }

    .turtles {
          font-family: turtles, apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial,sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
          background: url(/media/images/Marble1.png) no-repeat center center;
          background-size: cover;
          color: #fff;
          -webkit-text-fill-color: transparent;
          -webkit-background-clip: text;
      }

      .small-outline {
          -webkit-text-stroke: 1px #002;
      }

      .big-outline {
          -webkit-text-stroke: 3px #002;
      }

      .header {
        text-align: center;
        vertical-align: middle;
      }

      .navbar-dark a span {
        color: #212529 !important;
      }

      @media only screen and (min-width: 600px) {
        .header {
          /* background-image: url('/media/images/art-deco-geometric-wallpaper.jpg');
          background-repeat: repeat;
          display: block;*/
          background-attachment: fixed;
          color: #eef;
        }
        .navbar {
          background-color: rgba(0, 0, 20, 0.7);
          border-bottom-left-radius: 10px;
          border-bottom-right-radius: 10px;
          color: #fff;
        }

        .navbar a {
          color: #fff;
        }

        .navbar .dropdown-item {
          color: #4e7999;
        }

        .header-text {
          padding-top: 100px;
          padding-bottom: 100px;
        }
      }

      body {
        background-color: #eee;
        color: #36516e;
      }

      h2, h3, h4, h5, h6, .h2, .h3, .h4, .h5, .h6 {
        color: #4e7999;
      }

      a {
        color: #6d9bb5;
      }

      section {
        padding-top: 10px;
      }

      footer {
        margin-top: 50px;
        padding-top: 20px;
        padding-bottom: 20px;

      }
    </style>

    <script src="/media/node_modules/three/build/three.js"></script>
    <script src="/media/nebula/postprocessing.min.js"></script>
    <script src="/media/js/nebula.js"></script>

    <style>
      #nebula canvas {
        position: fixed;
        top:0;
        left:0;
        z-index:-99;
      }
      .content-block {
        padding-top: 20px;
        background-color: #fff;
      }
    </style>

  </head>
  <body>
    <div id="nebula" class="container-fluid header">
      <div class="col-md-8 offset-md-2">
        <nav class="navbar navbar-expand-lg navbar">
          <a class="navbar-brand" href="https://m5mat.github.io/">M5MAT</a>
          <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"><i class="fas fa-bars"></i></span>
          </button>

          <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav mr-auto">

              <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                  About
                </a>
                <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                      <a class="dropdown-item" href="/pages/about.html">About Me</a>
                      <a class="dropdown-item" href="/pages/m5mat.html">M5MAT</a>
                      <a class="dropdown-item" href="/pages/2e1hnk.html">2E1HNK</a>
                      <a class="dropdown-item" href="/pages/m0izz.html">M0IZZ</a>
                      <a class="dropdown-item" href="/pages/g2ks.html">G2KS</a>
                      <a class="dropdown-item" href="/pages/gb1wsg.html">GB1WSG</a>
                </div>
              </li>

              <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                  Categories
                </a>
                <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                    <a class="dropdown-item" href="Blog">Blog (16)</a>
                    <a class="dropdown-item" href="Contests">Contests (40)</a>
                    <a class="dropdown-item" href="Projects">Projects (5)</a>
                </div>
              </li>

              <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                  Tools
                </a>
                <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                    <a class="dropdown-item" href="/pages/pass-predictor.html">Satellite Pass Predictor</a>
                  <!--
                    <div class="dropdown-divider"></div>
                    <a class="dropdown-item" href="#">Something else here</a>
                  -->
                </div>
              </li>
            </ul>

            <form class="form-inline my-2 my-lg-0" action="/pages/search.html" method="get">
              <input class="form-control mr-sm-2" name="q" type="search" placeholder="Search" aria-label="Search">
              <div class="input-group-append">
                <button class="btn btn-outline-secondary my-2 my-sm-0" type="submit"><i class="fas fa-search"></i></button>
              </div>
            </form>

            <ul class="navbar-nav ml-auto">
                  <li class="nav-item">
                    <a class="nav-link" href="feed/all.xml"><i class="fa fa-rss fa-lg"></i> Feed</a>
                  </li>
            </ul>
            <!--
            <form class="form-inline my-2 my-lg-0">
              <input id="searchCallsign" class="form-control mr-sm-2" type="search" placeholder="Search the Logbook" aria-label="Search">
              <button class="btn btn-outline-success my-2 my-sm-0" id="btnLogSearch">Search</button>
            </form>
            -->
          </div>
        </nav>

        <div class="header-text">
          <h1 class="display-6 small-outline">

                    &mdash;Satellite&mdash;

          </h1>
          <h1 class="display-1 big-outline">  Pass Predictor
</h1>
          <h4 class="display-4"></h4>
        </div>
      </div>
    </div>

    <div class="container-fluid content-block">
      <div class="row">
        <div class="col-md-6 offset-md-2">
<section>
    <em class="text-muted">By Matt, M5MAT</em>
  </section>




  <section>
        <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

<div class="form-row">
  <div class="col">
    <label for="locator">Locator</label>
    <input type="text" class="form-control" id="locator" onChange="updatePrediction()" value="IO81xw" />
  </div>
  <div class="col">
    <label for="ele">Minimum Elevation (&deg;)</label>
    <input type="text" class="form-control" id="ele" onChange="updatePrediction()" value="10" />
  </div>
  <div class="col">
    <label for="tz">Time Zone</label>
    <select class="form-control" id="tz" onChange="updatePrediction()">
    </select>
  </div>
</div>

<div class="form-group">
  <label for="sat">Satellite(s)</label>
  <select class="form-control" id="sat" onChange="updatePrediction()" multiple>
  </select>
  <span class="font-weight-light">Ctrl+Click to select multiple satellites or select a group below</span>
</div>

<div class="form-group">
  <button class="btn" onclick="selectSats(fmSats)">FM Sats</button>
  <button class="btn" onclick="selectSats(linearSats)">Linear Sats</button>
  <button class="btn" onclick="selectSats(digitalSats)">Digital Sats</button>
</div>

<ul class="nav nav-tabs justify-content-end" id="myTab" role="tablist">
  <li class="nav-item">
    <a class="nav-link active" id="list-tab" data-toggle="tab" href="#list" role="tab" aria-controls="list" aria-selected="true"><i class="fas fa-list"></i></a>
  </li>
  <li class="nav-item">
    <a class="nav-link" id="timetable-tab" data-toggle="tab" href="#timetable" role="tab" aria-controls="timetable" aria-selected="false"><i class="fas fa-th"></i></a>
  </li>
</ul>

<div class="tab-content" id="myTabContent">
  <div class="tab-pane fade show active" id="list" role="tabpanel" aria-labelledby="list-tab">
    <i>All times in <span id="timezone-indicator">UTC</span></i>
    <table id="pass-table" class="table">
      <thead>
        <tr>
          <th>Satellite</th>
          <th>AOS</th>
          <th>LOS</th>
          <th>Duration</th>
          <th>Ele</th>
          <th></th>
        </tr>
      </thead>
      <tbody>

      </tbody>
    </table>
  </div>
  <div class="tab-pane fade" id="timetable" role="tabpanel" aria-labelledby="timetable-tab">
    <div class="timetable"></div>
  </div>
</div>

<div class="modal" id="modal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-body">
        <div id="polar-plot" style="width: 100%;"></div>
      </div>
    </div>
  </div>
</div>

<script src="/media/node_modules/jspredict/satellite.js"></script>

<script src="/media/node_modules/jspredict/jspredict.js"></script>

<script src="/media/node_modules/moment/moment.js"></script>

<script src="/media/node_modules/moment-timezone/builds/moment-timezone-with-data-10-year-range.min.js"></script>

<script src="/media/js/HamGridSquare.js"></script>

<script src="/media/js/FileSaver.min.js"></script>

<script src="/media/js/Blob.js"></script>

<script src="/media/js/ics.js"></script>

<script src="/media/js/timetable.js"></script>

<script src="https://cdn.jsdelivr.net/npm/js-cookie@beta/dist/js.cookie.min.js"></script>

<script>
  var timeDisplayFormat = "ddd, HH:mm:ss";

  if(typeof Cookies.get('locator') !== "undefined") {
    $('#locator').val(Cookies.get('locator'));
  }

  if(typeof Cookies.get('minElevation') !== "undefined") {
    $('#ele').val(Cookies.get('minElevation'));
  }

  // Load TZ names
  $.each(moment.tz.names(), function(index, name) {
      var selected = "";
      if (name == Cookies.get('tz') || ( typeof Cookies.get('tz') === "undefined" && name == moment.tz.guess() ) ) {
        selected = " selected";
      }
      $('#tz').append("<option value=\"" + name + "\" " + selected + ">" + name + "</option>")
  });


  // Set the QTH
  var qth = [HamGridSquare.toLatLon($('#locator').val())[0], HamGridSquare.toLatLon($('#locator').val())[1], 1];

  // Set up satellite groups
  var fmSats = ["SAUDISAT 1C (SO-50)", "FOX-1D (AO-92)", "RADFXSAT (FOX-1B)", "DUCHIFAT-3"];
  var linearSats = ["NAYIF-1 (EO-88)", "OSCAR 7 (AO-7)", "JAS-2 (FO-29)", "FUNCUBE-1 (AO-73)", "XW-2A", "XW-2B", "XW-2F", "NUSAT-1 (FRESCO)", "JY1SAT (JO-97)"];
  var digitalSats = ["PCSAT (NO-44)", "LAPAN-A2", "BRICSAT2 (NO-103)", "PSAT2 (NO-104)", "ISS (ZARYA)"];

  // Load TLEs
  var tle = {};
  var sat_names = [];

  // Initialise the timetable view
  var timetable = new Timetable();
  timetable.setScope(0, 23); // optional, only whole hours between 0 and 23

  $.get("/media/tle/amateur.txt", function(txt) {
    var lines = txt.split("\n");

    for (var i = 0, len = lines.length; i < len; i=i+3) {
      sat_names.push(lines[i].trim());
      tle[lines[i].trim()] = [lines[i+1], lines[i+2]];
    }

    sat_names.sort();

    $.each(sat_names, function(index, value) {
      $('#sat').append("<option value=\"" + value + "\">" + value + "</option>")
    });

    console.log(tle);
  }).done(function() {
    updatePrediction();
  });

  function updatePrediction() {
    var locator = $('#locator').val();
    var minElevation = $('#ele').val();
    var tz = $('#tz').children("option:selected").val();

    Cookies.set('locator', locator);
    Cookies.set('minElevation', minElevation);
    Cookies.set('tz', tz);

    $('#timezone-indicator').html(tz);

    qth = [HamGridSquare.toLatLon(locator)[0], HamGridSquare.toLatLon(locator)[1], 1];

    // Clear out any old data
    $("#pass-table > tbody tr").remove();
    var allPasses = [];
    timetable.locations = [];
    timetable.events = [];

    $.each($('#sat').children("option:selected"), function(index, element) {
      var sat = element.value;
      console.log("Processing " + sat);

      timetable.addLocations([sat]);

      var sat_tle = sat + "\n" + tle[sat][0] + "\n" + tle[sat][1];

      var passes = jspredict.transits(sat_tle, qth, moment(), moment().add(1, 'days'), minElevation, 10);

      $.each(passes, function(index, pass) {
        pass.satellite = sat;
        pass.aos = jspredict.observe(sat_tle, qth, pass.start);
        pass.los = jspredict.observe(sat_tle, qth, pass.end);
        allPasses.push(pass);
        console.log(pass);
        timetable.addEvent(
          null,
          sat,
          new Date(pass.start),
          new Date(pass.end)
        );
        console.log(timetable);
      });
    });

    allPasses.sort(compare);

    console.log(allPasses);

    $.each(allPasses, function(index, element) {
      var calTitle = element.satellite;
      var calDescription = "AZ: " + element.aos.azimuth.toFixed(0) + "&deg; -> " + element.los.azimuth.toFixed(0) + "&deg;, EL: " + element.maxElevation.toFixed(1) + "&deg;";
      var calStart = moment.utc(element.start).format();
      var calEnd = moment.utc(element.end).format();

      $('#pass-table > tbody:last-child').append(
        "<tr><td>" + element.satellite + "</td>" +
        "<td>" + moment.utc(element.start).tz(tz).format(timeDisplayFormat) + "<p class=\"font-weight-light\">AZ: " + element.aos.azimuth.toFixed(0) + "&deg;</p></td>" +
        "<td>" + moment.utc(element.end).tz(tz).format(timeDisplayFormat) + "<p class=\"font-weight-light\">AZ: " + element.los.azimuth.toFixed(0) + "&deg;</p></td>" +
        "<td>" + (element.duration/60000).toFixed(0) + " mins</td>" +
        "<td>" + element.maxElevation.toFixed(1) + "&deg;</td>" +
        "<td><a href='javascript:downloadIcal(\"" + calTitle + "\", \"" + calDescription + "\", \"" + locator + "\", \"" + calStart + "\", \"" + calEnd + "\")'><i class='far fa-calendar-plus'></i></a>&nbsp;" +
        "<a href='javascript:polarPlot([[" + element.aos.azimuth + ",0,\"AOS\"],[" + element.apexAzimuth + "," + element.maxElevation + ",\"TCA\"],[" + element.los.azimuth + ",0,\"LOS\"]])'><i class='fas fa-globe'></i></a>" +
        "</td>" +
        "</tr>")
    });

    // Render the timetable
    var renderer = new Timetable.Renderer(timetable);
    renderer.draw('.timetable'); // any css selector
  }

  function selectSats(satArr) {
    // Unselect all previously selected elements
    $('#sat').children("option:selected").removeAttr('selected');

    // Select all elements in satArr
    $.each(satArr, function(index, element) {
      $('#sat option[value=\'' + element + '\']').attr('selected', true);
    });

    // Update the prediction table
    updatePrediction();
  }

  function downloadIcal(subject, description, location, begin, end) {
    console.log("Generating ics");
    var cal = ics();
    cal.addEvent(subject, description, location, begin, end);
    console.log(cal);
    cal.download(subject + "-" + begin);
  }

  function compare( a, b ) {
    if ( a.start < b.start ){
      return -1;
    }
    if ( a.start > b.start ){
      return 1;
    }
    return 0;
  }

  function polarPlot(plotData) {
    var data = [
      {
        type: "scatterpolar",
        mode: "lines+text",
        r: [],
        theta: [],
        text: [],
        textposition: [],
        textfont: {
          size: 20
        },
        line: {
          color: "#ff66ab"
        },
        marker: {
          color: "#8090c7",
          symbol: "square",
          size: 8
        },
        subplot: "polar"
      }
    ];

    $.each(plotData, function(index, element) {
        data[0].text.push(element[2]);
        data[0].r.push(element[1]);
        data[0].theta.push(element[0]);
        if ( element[0] < 90 ) {
          data[0].textposition.push("top right");
        } else if (element[0] < 180) {
          data[0].textposition.push("bottom right");
        } else if (element[0] < 270) {
          data[0].textposition.push("bottom left");
        } else {
          data[0].textposition.push("top left");
        }
    });

    var layout = {
      showlegend: false,
      height: 600,
      polar: {
        domain: {
          x: [0,0],
          y: [0,0]
        },
        radialaxis: {
          visible: false,
          rangemode: "tozero",
          range: [90, 0]
        },
        angularaxis: {
          tickfont: {
            size: 16
          },
          direction: "clockwise"
        }
      }
    }

    $('#modal').modal('show');
    console.log(Plotly.newPlot('polar-plot', data, layout));

  }

</script>
  </section>

        </div>
        <div class="col-md-2 offset-md-1">
          <div class="profile-sidebar">
    				<!-- SIDEBAR USERPIC -->
    				<div class="profile-userpic ">
    					<img src="https://twitter.com/m5mat/profile_image?size=bigger" class="img-responsive mx-auto d-block" alt="Profile pic">
    				</div>
    				<!-- END SIDEBAR USERPIC -->
    				<!-- SIDEBAR USER TITLE -->
    				<div class="profile-usertitle">
    					<div class="profile-usertitle-name">
    						Matt
    					</div>
    					<div class="profile-usertitle-job">
    						M5MAT<br />
                <span class="text-muted">ex 2E1HNK</span>
    					</div>
    				</div>
    				<!-- END SIDEBAR USER TITLE -->
    				<!-- SIDEBAR BUTTONS -->
            <!--
    				<div class="profile-userbuttons">
    					<button type="button" class="btn btn-success btn-sm">Follow</button>
    					<button type="button" class="btn btn-danger btn-sm">Message</button>
    				</div>
          -->
    				<!-- END SIDEBAR BUTTONS -->
    				<!-- SIDEBAR MENU -->
            <!--
    				<div class="profile-usermenu">
    					<ul class="nav">
    						<li class="active">
    							<a href="#">
    							<i class="glyphicon glyphicon-home"></i>
    							Overview </a>
    						</li>
    						<li>
    							<a href="#">
    							<i class="glyphicon glyphicon-user"></i>
    							Account Settings </a>
    						</li>
    						<li>
    							<a href="#" target="_blank">
    							<i class="glyphicon glyphicon-ok"></i>
    							Tasks </a>
    						</li>
    						<li>
    							<a href="#">
    							<i class="glyphicon glyphicon-flag"></i>
    							Help </a>
    						</li>
    					</ul>
    				</div>
          -->
    				<!-- END MENU -->
    			</div>

          <a class="twitter-timeline" href="https://twitter.com/m5mat" data-tweet-limit="5" data-width="399" ></a>
          <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
        </div>
      </div>
    </div>


    <footer class="bg-dark">
      <div class="container">
        <div class="row">
          <div class="col-md-2 offset-md-2 text-center">
            <a href="https://qrz.com/db/m5mat"><img src="/media/images/qrz.png" class="img-fluid" style="max-height: 56px;"/></a>
          </div>

          <div class="col-md-2 text-center">
            <a href="https://twitter.com/m5mat"><i class="fab fa-twitter display-4 text-light"></i></a>
          </div>
          <div class="col-md-2 text-center">
            <a href="https://github.com/m5mat"><i class="fab fa-github display-4 text-light"></i></a>
          </div>
          <div class="col-md-2 text-center">
            <a href="https://reddit.com/user/2e1hnk"><i class="fab fa-reddit display-4 text-light"></i></a>
          </div>
        </div>
      </div>
    </footer>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->

    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
    <script type="text/javascript">
        document.getElementById("btnLogSearch").onclick = function () {
            var url = "/logsearch.html?callsign=" + document.getElementById("searchCallsign").value;
            location.href(url);
            return false;
        };
    </script>
    <script id="dsq-count-scr" src="//m5mat.disqus.com/count.js" async></script>

    <script>

       $(document).ready(function () {
         // Convert tables to bootstrap style
          $("table").attr("class","table table-striped");

          // Make images responsive
          $("img").attr("class","img-fluid");
       });


    </script>

  </body>
</html>